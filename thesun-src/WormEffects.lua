local log = require("log")

---@type PlayerUtils
local PlayerUtils = include("thesun-src.PlayerUtils")
---@type Const
local Const = include("thesun-src.Const")

local hookWormSteps = {
  [0] = 0,
  10,
  20,
  20,
  20,
  20,
  20,
  10,
  0,
  -10,
  -20,
  -20,
  -20,
  -20,
  -20,
  -10,
}
local wiggleWormSteps = {
  [0] = 8.134732861516,
  14.862896509548,
  19.021130325903,
  19.890437907365,
  17.320508075689,
  11.755705045849,
  4.1582338163552,
  -4.1582338163552,
  -11.755705045849,
  -17.320508075689,
  -19.890437907365,
  -19.021130325903,
  -14.862896509548,
  -8.134732861516,
  0,
}
local ringWormSteps = {
  [0] = {
    a = 0.063024391856267,
    r = 11.755705045849,
  },
  {
    a = 0.22802439185627,
    r = 19.021130325903,
  },
  {
    a = 0.43197560814373,
    r = 19.021130325903,
  },
  {
    a = 0.59697560814373,
    r = 11.755705045849,
  },
  {
    a = 0.66,
    r = 2.4492935982947e-15,
  },
  {
    a = 0.59697560814373,
    r = -11.755705045849,
  },
  {
    a = 0.43197560814373,
    r = -19.021130325903,
  },
  {
    a = 0.22802439185627,
    r = -19.021130325903,
  },
  {
    a = 0.063024391856267,
    r = -11.755705045849,
  },
  {
    a = 0.0,
    r = 1.2864981197413e-14,
  },
}
local ouroborosWormSteps = {
  [0] = {
    a = -0.047486305366367,
    r = 2.3826220941273,
  },
  {
    a = -0.093676604281697,
    r = 4.8805289065645,
  },
  {
    a = -0.13851376993973,
    r = 7.4746957481444,
  },
  {
    a = -0.18187490678599,
    r = 10.158012187872,
  },
  {
    a = -0.22364116495838,
    r = 12.923123441902,
  },
  {
    a = -0.26369806604639,
    r = 15.762450532487,
  },
  {
    a = -0.30193581686845,
    r = 18.668211061431,
  },
  {
    a = -0.33824961040743,
    r = 21.632440541102,
  },
  {
    a = -0.37253991307939,
    r = 24.647014224535,
  },
  {
    a = -0.40471273754819,
    r = 27.703669374807,
  },
  {
    a = -0.43467990033826,
    r = 30.794027912614,
  },
  {
    a = -0.4623592635394,
    r = 33.909619380014,
  },
  {
    a = -0.48767495994103,
    r = 37.041904157356,
  },
  {
    a = -0.510557600979,
    r = 40.182296869788,
  },
  {
    a = -0.53094446692476,
    r = 43.322189919171,
  },
  {
    a = -0.54877967879584,
    r = 46.452977076908,
  },
  {
    a = -0.56401435151621,
    r = 49.566077073018,
  },
  {
    a = -0.57660672790688,
    r = 52.652957116801,
  },
  {
    a = -0.58652229313947,
    r = 55.705156284624,
  },
  {
    a = -0.59373386933888,
    r = 58.714308710722,
  },
  {
    a = -0.59822169007603,
    r = 61.672166517459,
  },
  {
    a = -0.59997345454622,
    r = 64.570622422186,
  },
  {
    a = -0.59898436128481,
    r = 67.401731958737,
  },
  {
    a = -0.59525712132766,
    r = 70.15773525266,
  },
  {
    a = -0.58880195078043,
    r = 72.831078290494,
  },
  {
    a = -0.57963654281689,
    r = 75.414433624794,
  },
  {
    a = -0.56778601918319,
    r = 77.900720458156,
  },
  {
    a = -0.55328286134088,
    r = 80.283124051189,
  },
  {
    a = -0.53616682143753,
    r = 82.555114401242,
  },
  {
    a = -0.51648481334877,
    r = 84.710464140692,
  },
  {
    a = -0.4942907840907,
    r = 86.743265605719,
  },
  {
    a = -0.46964556595483,
    r = 88.647947028804,
  },
  {
    a = -0.442616709771,
    r = 90.419287810561,
  },
  {
    a = -0.41327829975525,
    r = 92.052432829031,
  },
  {
    a = -0.38171075045016,
    r = 93.542905747237,
  },
  {
    a = -0.34800058631413,
    r = 94.886621282512,
  },
  {
    a = -0.3122402045639,
    r = 96.079896403973,
  },
  {
    a = -0.27452762192016,
    r = 97.119460427457,
  },
  {
    a = -0.23496620595059,
    r = 98.002463980234,
  },
  {
    a = -0.19366439174646,
    r = 98.726486810944,
  },
  {
    a = -0.15073538470967,
    r = 99.289544423332,
  },
  {
    a = -0.10629685026453,
    r = 99.690093515622,
  },
  {
    a = -0.060470591345076,
    r = 99.927036210593,
  },
  {
    a = -0.013382214541666,
    r = 99.999723064788,
  },
  {
    a = 0.034839214177957,
    r = 99.907954848592,
  },
  {
    a = 0.084061523229504,
    r = 99.651983092307,
  },
  {
    a = 0.13414979768526,
    r = 99.232509396725,
  },
  {
    a = 0.18496674906655,
    r = 98.650683510087,
  },
  {
    a = 0.23637309164186,
    r = 97.908100176707,
  },
  {
    a = 0.28822792419942,
    r = 97.006794765886,
  },
  {
    a = 0.34038911624756,
    r = 95.949237693105,
  },
  {
    a = 0.39271369758457,
    r = 94.738327648791,
  },
  {
    a = 0.44505825017004,
    r = 93.377383653206,
  },
  {
    a = 0.49727930122375,
    r = 91.870135959244,
  },
  {
    a = 0.5492337164746,
    r = 90.220715828067,
  },
  {
    a = 0.60077909248171,
    r = 88.433644205604,
  },
  {
    a = 0.65177414695231,
    r = 86.513819330955,
  },
  {
    a = 0.70207910598672,
    r = 84.466503310656,
  },
  {
    a = 0.75155608718888,
    r = 82.297307695611,
  },
  {
    a = 0.80006947759242,
    r = 80.012178100222,
  },
  {
    a = 0.84748630536636,
    r = 77.617377905873,
  },
  {
    a = 0.89367660428169,
    r = 75.119471093436,
  },
  {
    a = 0.93851376993973,
    r = 72.525304251856,
  },
  {
    a = 0.98187490678599,
    r = 69.841987812128,
  },
  {
    a = 1.0236411649584,
    r = 67.076876558098,
  },
  {
    a = 1.0636980660464,
    r = 64.237549467513,
  },
  {
    a = 1.1019358168684,
    r = 61.331788938569,
  },
  {
    a = 1.1382496104074,
    r = 58.367559458899,
  },
  {
    a = 1.1725399130794,
    r = 55.352985775465,
  },
  {
    a = 1.2047127375482,
    r = 52.296330625194,
  },
  {
    a = 1.2346799003383,
    r = 49.205972087386,
  },
  {
    a = 1.2623592635394,
    r = 46.090380619986,
  },
  {
    a = 1.287674959941,
    r = 42.958095842645,
  },
  {
    a = 1.310557600979,
    r = 39.817703130213,
  },
  {
    a = 1.3309444669248,
    r = 36.67781008083,
  },
  {
    a = 1.3487796787958,
    r = 33.547022923092,
  },
  {
    a = 1.3640143515162,
    r = 30.433922926982,
  },
  {
    a = 1.3766067279069,
    r = 27.347042883199,
  },
  {
    a = 1.3865222931395,
    r = 24.294843715377,
  },
  {
    a = 1.3937338693389,
    r = 21.285691289279,
  },
  {
    a = 1.398221690076,
    r = 18.327833482541,
  },
  {
    a = 1.3999734545462,
    r = 15.429377577814,
  },
  {
    a = 1.3989843612848,
    r = 12.598268041263,
  },
  {
    a = 1.3952571213277,
    r = 9.8422647473397,
  },
  {
    a = 1.3888019507804,
    r = 7.1689217095057,
  },
  {
    a = 1.3796365428169,
    r = 4.5855663752056,
  },
  {
    a = 1.3677860191832,
    r = 2.099279541844,
  },
  {
    a = 1.3532828613409,
    r = -0.28312405118853,
  },
  {
    a = 1.3361668214375,
    r = -2.5551144012424,
  },
  {
    a = 1.3164848133488,
    r = -4.7104641406922,
  },
  {
    a = 1.2942907840907,
    r = -6.7432656057186,
  },
  {
    a = 1.2696455659548,
    r = -8.6479470288043,
  },
  {
    a = 1.242616709771,
    r = -10.419287810561,
  },
  {
    a = 1.2132782997553,
    r = -12.052432829031,
  },
  {
    a = 1.1817107504502,
    r = -13.542905747237,
  },
  {
    a = 1.1480005863141,
    r = -14.886621282512,
  },
  {
    a = 1.1122402045639,
    r = -16.079896403973,
  },
  {
    a = 1.0745276219202,
    r = -17.119460427457,
  },
  {
    a = 1.0349662059506,
    r = -18.002463980234,
  },
  {
    a = 0.99366439174646,
    r = -18.726486810944,
  },
  {
    a = 0.95073538470967,
    r = -19.289544423332,
  },
  {
    a = 0.90629685026453,
    r = -19.690093515622,
  },
  {
    a = 0.86047059134507,
    r = -19.927036210593,
  },
  {
    a = 0.81338221454166,
    r = -19.999723064788,
  },
  {
    a = 0.76516078582204,
    r = -19.907954848592,
  },
  {
    a = 0.71593847677049,
    r = -19.651983092307,
  },
  {
    a = 0.66585020231473,
    r = -19.232509396725,
  },
  {
    a = 0.61503325093345,
    r = -18.650683510087,
  },
  {
    a = 0.56362690835813,
    r = -17.908100176707,
  },
  {
    a = 0.51177207580058,
    r = -17.006794765886,
  },
  {
    a = 0.45961088375243,
    r = -15.949237693104,
  },
  {
    a = 0.40728630241542,
    r = -14.73832764879,
  },
  {
    a = 0.35494174982996,
    r = -13.377383653206,
  },
  {
    a = 0.30272069877625,
    r = -11.870135959244,
  },
  {
    a = 0.25076628352539,
    r = -10.220715828066,
  },
  {
    a = 0.19922090751828,
    r = -8.4336442056036,
  },
  {
    a = 0.14822585304768,
    r = -6.5138193309546,
  },
  {
    a = 0.097920894013274,
    r = -4.4665033106554,
  },
  {
    a = 0.048443912811113,
    r = -2.2973076956104,
  },
  {
    a = -6.9477592426592e-05,
    r = -0.012178100221504,
  }
}

-- local step = math.pi / 15
-- local actStep = 0
-- for i = 0, 119 do
--   actStep = actStep + step
--   wiggleWormSteps[i] = 20 * math.sin(2* actStep)
--   ringWormSteps[i] = {
--     a = 0.33 - 0.33 * math.cos(3 * actStep), -- less than 2: sparsed, more than 2: dense
--     r = 20 * math.sin(3 * actStep)
--   }
--   ouroborosWormSteps[i] = {
--     a = 0.4 + math.sin(actStep / 4 - 2.73),
--     r = 40 + 60 * math.sin(actStep / 4 - 0.73)
--   }
-- end

---@class WormEffects
---@field GetModifiedOrbit fun(orb: Orbital<EntityOrbital>): number, number

local WormEffects = {}

---@param orb Orbital<EntityOrbital>
---@return number, number
function WormEffects.GetModifiedOrbit(orb)
  if not orb.entity then
    return 0, 0
  end
  local radius = orb.radius
  local angle = orb.angle
  if (orb.entity:HasTearFlags(TearFlags.TEAR_BOOMERANG)) then
    orb.direction = orb.direction + orb.boomerang * 0.02
    if (math.abs(orb.direction + orb.boomerang) > 2) then
      orb.boomerang = -orb.boomerang
    end
  end
  if (orb.entity:HasTearFlags(TearFlags.TEAR_HYDROBOUNCE)) then
    --log.Value("Hydro Bounce", orb.entity.FallingAcceleration)
    -- if (orb.entity.Height < -20) then
    --   orb.entity.Height = -20
    -- else
    --   orb.entity.Height = -10
    -- end
    --orb.entity.Height = wiggleWormSteps[orb.entity.FrameCount % 15] - 23
  end
  if (orb.flags & Const.CustomFlags.TEAR_SQUARE ~= 0) then
    radius = radius + hookWormSteps[orb.entity.FrameCount % 16]
  end
  if (orb.flags & Const.CustomFlags.TEAR_WIGGLE ~= 0) then
    radius = radius + wiggleWormSteps[orb.entity.FrameCount % 15]
  end
  if (orb.flags & Const.CustomFlags.TEAR_SPIRAL) ~= 0 then
    local offset = ringWormSteps[orb.entity.FrameCount % 10]
    angle = angle + offset.a
    radius = radius + offset.r
  end
  if (orb.flags & Const.CustomFlags.TEAR_BIG_SPIRAL ~= 0) then
    local offset = ouroborosWormSteps[orb.entity.FrameCount % 120]
    angle = angle + offset.a
    radius = radius + offset.r
  end
  return angle, radius
end

return WormEffects
